
<br>
<div class="container">

    <div class="row " style="padding:50px 0;">
        
        <div class="col">
            <h2>
                <i class="bi bi-pencil"></i> Edit
            </h2>
        </div>
        <div class="col text-end">
            <h2>
                <a href="javascript:void(0)" id="save_button" title="Save file"><i class="bi bi-floppy"></i></a>
                &nbsp;&nbsp;
                <a href="javascript:void(0)" id="cancel_button" title="Cancel"><i class="bi bi-x-circle"></i></a>
            </h2>
        </div>
        
        
        
        
        
        <input type="hidden" id="full_path" value="{{full_path}}">
        
        
        
        
        <div id="editor1"></div>
        
        
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js" crossorigin="anonymous"></script>


<script src="/__assets/codemirror/cm6.bundle.min.js" crossorigin="anonymous"></script>


<script>
    $(document).ready(() => {
        
        let decodeHtmlEntities = (str) => { 
            const textarea = document.createElement('textarea'); 
            textarea.innerHTML = str; 
            return textarea.value; 
        };
        
        
        
        let val = decodeHtmlEntities(`{{ file_data }}`);
        
        const view = cm6.createEditorView(undefined, document.getElementById("editor1"));
        const initialState = cm6.createEditorState(val);
        view.setState(initialState);

        /*
        let button = document.querySelector("#search");
        button.addEventListener("click", () => {
            cm6.openSearchPanel(view);
        })
        */
        
        
        
        
        $('#save_button').on('click', () => {
            
            //let body = tinymce.get("textarea1").getContent();
            let body = view.state.doc.toString();
            
            //console.log('body=', body);
            
            
            //return;
            
            //let file_name = $('#file_name').val();
            let full_path = $('#full_path').val();
            
            let formData = new FormData();
            //formData.append('file_name', file_name);
            formData.append('full_path', full_path);
            formData.append('body', body);
            formData.append('save_as_source', '1');

            $.ajax({
                url: '/api/edit',
                data: formData,
                type: 'POST',
                contentType: false,
                processData: false,
            }).done(function (data) {
                if (data.code == 200) {
                    
                    
                    let arr = full_path.split('/');
                    
                    //arr.shift();
                    arr.pop();
                    
                    console.log( arr.join('/') );
                    
                    location.href = arr.join('/');
                    
                }
            }).fail(function(data) {
                if (data.responseJSON.msg) {
                    alert(data.responseJSON.msg);
                }
            });
            
            
        });
        
        $('#cancel_button').on('click', () => {
            
            let full_path = $('#full_path').val();
            
            let arr = full_path.split('/');
            
            //arr.shift();
            arr.pop();
            
            location.href = arr.join('/');
        });
        
        
        
    });
    
</script>
